<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Trainer Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #f8fafc; 
            line-height: 1.6;
        }
        
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #48bb78;
            margin-right: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #667EEA;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .action-card {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-card h3 {
            margin-bottom: 1rem;
            color: #1a202c;
        }
        
        .action-card p {
            color: #718096;
            margin-bottom: 1rem;
        }
        
        .btn {
            background: #667EEA;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
            margin: 0.5rem 0.5rem 0.5rem 0;
            font-size: 0.9rem;
        }
        
        .btn:hover { 
            background: #5a5fcf; 
            transform: translateY(-1px);
        }
        
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .log div {
            margin: 0.25rem 0;
        }
        
        .success { color: #48bb78; }
        .error { color: #f56565; }
        .info { color: #63b3ed; }
        
        @media (max-width: 768px) {
            .dashboard { padding: 1rem; }
            .header h1 { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .actions { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ü§ñ AI-Trainer Dashboard</h1>
            <p>Template Intelligence Engine</p>
            <p><span class="status-indicator"></span> Sistema Operativo</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="serverStatus">‚è≥</div>
                <div class="stat-label">Server Status</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="apiCalls">0</div>
                <div class="stat-label">API Calls Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="templateCount">156</div>
                <div class="stat-label">Templates Generated</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="accuracyScore">94%</div>
                <div class="stat-label">Accuracy Score</div>
            </div>
        </div>
        
        <div class="actions">
            <div class="action-card">
                <h3>üé® Template Generation</h3>
                <p>Genera layout intelligenti per business specifici</p>
                <button class="btn" id="btn-layout-generation">Test Layout Generation</button>
                <button class="btn" id="btn-template-creation">Test Template Creation</button>
            </div>
            
            <div class="action-card">
                <h3>üìä System Monitoring</h3>
                <p>Controlla stato sistema e performance</p>
                <button class="btn" id="btn-server-status">Check Server Status</button>
                <button class="btn" id="btn-health-check">Health Check</button>
            </div>
            
            <div class="action-card">
                <h3>üîß Debug Tools</h3>
                <p>Strumenti per testing e debug</p>
                <button class="btn" id="btn-test-api">Test Full API</button>
                <button class="btn" id="btn-clear-logs">Clear Logs</button>
            </div>
            
            <div class="action-card">
                <h3>üóÑÔ∏è Storage Analytics</h3>
                <p>Visualizza informazioni su dati e storage</p>
                <button class="btn" id="btn-storage-info">Storage Stats</button>
                <button class="btn" id="btn-training-history">Training History</button>
                <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div style="text-align: center; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                        <div style="font-weight: bold; color: #667EEA;" id="totalSamples">-</div>
                        <div style="font-size: 0.8rem; color: #666;">Total Samples</div>
                    </div>
                    <div style="text-align: center; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                        <div style="font-weight: bold; color: #667EEA;" id="customSitesCount">-</div>
                        <div style="font-size: 0.8rem; color: #666;">Custom Sites</div>
                    </div>
                </div>
            </div>
            
            <div class="action-card">
                <h3>üé® Generate New Layout</h3>
                <p>Testa l'AI allenata - Genera layout con stili appresi</p>
                <div style="margin: 1rem 0;">
                    <select id="generated-business-type" style="width: 48%; padding: 0.5rem; margin-right: 4%; margin-bottom: 0.5rem;">
                        <option value="restaurant">Restaurant</option>
                        <option value="tech-startup">Tech Startup</option>
                        <option value="ecommerce">E-commerce</option>
                        <option value="portfolio">Portfolio</option>
                        <option value="wellness">Wellness</option>
                        <option value="real-estate">Real Estate</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="generated-style" style="width: 48%; padding: 0.5rem; margin-bottom: 0.5rem;">
                        <option value="minimal">Minimal (AI Learned)</option>
                        <option value="elegant">Elegant (AI Learned)</option>
                        <option value="casual">Casual (AI Learned)</option>
                        <option value="creative">Creative (AI Learned)</option>
                        <option value="professional">Professional (AI Learned)</option>
                    </select>
                    <input type="text" id="business-name" placeholder="Nome Business (es: My Restaurant)" 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                </div>
                <button class="btn" id="btn-generate-layout" style="background: #10b981;">üé® Generate AI Layout</button>
                <button class="btn" id="btn-preview-layout">üëÄ Preview Generated</button>
            </div>

            <div class="action-card">
                <h3>ü§ñ AI Training</h3>
                <p>Avvia training AI con dataset reale</p>
                <button class="btn" id="btn-start-training" style="background: #e74c3c;">Start Training Collection</button>
                <button class="btn" id="btn-training-status">Training Status</button>
            </div>
            
            <div class="action-card">
                <h3>üîó Custom Training</h3>
                <p>Allena l'AI con i tuoi siti preferiti</p>
                <div style="margin: 1rem 0;">
                    <input type="url" id="custom-url" placeholder="https://example.com" 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                    <select id="business-type" style="width: 48%; padding: 0.5rem; margin-right: 4%;">
                        <option value="restaurant">Restaurant</option>
                        <option value="tech-startup">Tech Startup</option>
                        <option value="ecommerce">E-commerce</option>
                        <option value="portfolio">Portfolio</option>
                        <option value="wellness">Wellness</option>
                        <option value="real-estate">Real Estate</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="style-type" style="width: 48%; padding: 0.5rem;">
                        <option value="minimal">Minimal</option>
                        <option value="elegant">Elegant</option>
                        <option value="casual">Casual</option>
                        <option value="creative">Creative</option>
                        <option value="professional">Professional</option>
                    </select>
                </div>
                <button class="btn" id="btn-add-custom-site">Add Site to Training</button>
                <button class="btn" id="btn-train-custom" style="background: #27ae60;">Train with Custom Sites</button>
            </div>
        </div>
        
        <div class="action-card" style="margin-top: 2rem;">
            <h3>üìã System Logs</h3>
            <div id="logs" class="log">
                <div class="info">üöÄ AI-Trainer Dashboard Initialized</div>
                <div class="success">‚úÖ Interface: Pure HTML (No React Issues)</div>
                <div class="info">üîÑ Checking server connection...</div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_KEY = 'ai-trainer-1e212623176704eea6dba3b62117d36c0f64d6512419defdd25226294c45a90d';
        const API_BASE = window.location.origin;
        
        // Logging function
        function logMessage(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logs.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        // API Functions
        async function getServerStatus() {
            try {
                logMessage('üîç Checking server status...');
                const response = await fetch(`${API_BASE}/status`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                const data = await response.json();
                logMessage(`‚úÖ Server Status: Online`, 'success');
                logMessage(`üìä Version: ${data.version}`, 'info');
                document.getElementById('serverStatus').textContent = response.ok ? '‚úÖ' : '‚ùå';
            } catch (error) {
                logMessage(`‚ùå Server Status Error: ${error.message}`, 'error');
                document.getElementById('serverStatus').textContent = '‚ùå';
            }
        }
        
        async function getHealthCheck() {
            try {
                logMessage('ü©∫ Running health check...');
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                logMessage(`‚úÖ Health Check: ${data.status}`, 'success');
                logMessage(`üîß Service: ${data.service}`, 'info');
            } catch (error) {
                logMessage(`‚ùå Health Check Error: ${error.message}`, 'error');
            }
        }
        
        async function testLayoutGeneration() {
            try {
                logMessage('üé® Testing layout generation...');
                const response = await fetch(`${API_BASE}/api/generate/layout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        businessType: 'restaurant',
                        currentBlocks: ['hero', 'about', 'menu', 'contact'],
                        requirements: { mobileFirst: true }
                    })
                });
                const data = await response.json();
                if (data.success) {
                    logMessage(`üé® Layout Generated: Score ${data.semanticScore}/100`, 'success');
                    document.getElementById('apiCalls').textContent = parseInt(document.getElementById('apiCalls').textContent) + 1;
                } else {
                    logMessage(`‚ö†Ô∏è Layout Generation: ${data.message}`, 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Layout Generation Error: ${error.message}`, 'error');
            }
        }
        
        async function testTemplateCreation() {
            try {
                logMessage('üñºÔ∏è Testing template creation...');
                const response = await fetch(`${API_BASE}/api/validate/template`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        template: { name: 'Test Template', blocks: ['hero', 'features'] },
                        businessType: 'tech-startup'
                    })
                });
                const data = await response.json();
                if (data.isValid) {
                    logMessage(`üñºÔ∏è Template Valid: Score ${data.scores?.creativity || 'N/A'}/100`, 'success');
                    document.getElementById('apiCalls').textContent = parseInt(document.getElementById('apiCalls').textContent) + 1;
                } else {
                    logMessage(`‚ö†Ô∏è Template Validation: Issues found`, 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Template Creation Error: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            logMessage('üîÑ Running full API test suite...');
            await getHealthCheck();
            await getServerStatus();
            await testLayoutGeneration();
            await testTemplateCreation();
            logMessage('‚úÖ Full API test completed', 'success');
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="info">üßπ Logs cleared</div>';
        }
        
        // ü§ñ AI TRAINING FUNCTIONS
        async function startTraining() {
            try {
                logMessage('üöÄ Starting AI training collection...', 'info');
                logMessage('‚ö†Ô∏è This will take 10-15 minutes and cost $30-80', 'info');
                
                const response = await fetch(`${API_BASE}/api/training/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        samples: 8, // Start with 8 samples
                        aiAnalysis: true,
                        saveLocal: true
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    logMessage(`üéØ Training started: ${data.trainingId}`, 'success');
                    logMessage(`üìä Collecting ${data.samplesCount} samples`, 'info');
                    // Poll for progress updates
                    pollTrainingProgress(data.trainingId);
                } else {
                    logMessage(`‚ùå Training start failed: ${data.error}`, 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Training Error: ${error.message}`, 'error');
            }
        }
        
        async function getTrainingStatus() {
            try {
                logMessage('üìä Checking training status...', 'info');
                const response = await fetch(`${API_BASE}/api/training/status`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                const data = await response.json();
                
                if (data.isTraining) {
                    logMessage(`üîÑ Training in progress: ${data.progress}%`, 'info');
                    logMessage(`üìà Samples collected: ${data.samplesCollected}/${data.totalSamples}`, 'info');
                } else {
                    logMessage(`‚úÖ Training completed: ${data.modelAccuracy}% accuracy`, 'success');
                }
            } catch (error) {
                logMessage(`‚ùå Status check failed: ${error.message}`, 'error');
            }
        }
        
        function pollTrainingProgress(trainingId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/training/progress/${trainingId}`, {
                        headers: { 'Authorization': `Bearer ${API_KEY}` }
                    });
                    const data = await response.json();
                    
                    logMessage(`üìà Progress: ${data.progress}% - ${data.currentStep}`, 'info');
                    
                    if (data.completed) {
                        clearInterval(interval);
                        logMessage('üéâ Training completed successfully!', 'success');
                        logMessage(`üéØ Final accuracy: ${data.accuracy}%`, 'success');
                    }
                } catch (error) {
                    clearInterval(interval);
                    logMessage(`‚ùå Progress polling failed: ${error.message}`, 'error');
                }
            }, 10000); // Poll every 10 seconds
        }
        
        // üîó CUSTOM TRAINING FUNCTIONS
        let customSites = [];
        
        function addCustomSite() {
            const url = document.getElementById('custom-url').value;
            const businessType = document.getElementById('business-type').value;
            const styleType = document.getElementById('style-type').value;
            
            if (!url) {
                logMessage('‚ùå Please enter a valid URL', 'error');
                return;
            }
            
            const customSite = {
                url: url,
                businessType: businessType,
                style: styleType,
                targetAudience: 'custom-defined',
                addedAt: new Date().toISOString()
            };
            
            customSites.push(customSite);
            logMessage(`‚úÖ Added: ${url} (${businessType} - ${styleType})`, 'success');
            logMessage(`üìä Custom sites queue: ${customSites.length}`, 'info');
            
            // Clear inputs
            document.getElementById('custom-url').value = '';
        }
        
        async function trainWithCustomSites() {
            if (customSites.length === 0) {
                logMessage('‚ùå No custom sites added. Add some sites first!', 'error');
                return;
            }
            
            try {
                logMessage(`üöÄ Starting custom training with ${customSites.length} sites...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/training/custom`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        customSites: customSites,
                        aiAnalysis: true,
                        saveLocal: true
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    logMessage(`üéØ Custom training started: ${data.trainingId}`, 'success');
                    logMessage(`üìä Processing ${data.sitesCount} custom sites`, 'info');
                    pollTrainingProgress(data.trainingId);
                    customSites = []; // Clear queue after starting
                } else {
                    logMessage(`‚ùå Custom training failed: ${data.error}`, 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Custom Training Error: ${error.message}`, 'error');
            }
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            logMessage('üöÄ Dashboard initialized successfully', 'success');
            logMessage('üì° No React dependencies - Pure HTML', 'info');
            
            // Setup event listeners for buttons (CSP-compliant)
            document.getElementById('btn-layout-generation').addEventListener('click', testLayoutGeneration);
            document.getElementById('btn-template-creation').addEventListener('click', testTemplateCreation);
            document.getElementById('btn-server-status').addEventListener('click', getServerStatus);
            document.getElementById('btn-health-check').addEventListener('click', getHealthCheck);
            document.getElementById('btn-test-api').addEventListener('click', testAPI);
            document.getElementById('btn-clear-logs').addEventListener('click', clearLogs);
            
            // üóÑÔ∏è Storage Analytics event listeners
            document.getElementById('btn-storage-info').addEventListener('click', getStorageInfo);
            document.getElementById('btn-training-history').addEventListener('click', getTrainingHistory);
            
            // üé® AI Layout Generation event listeners
            document.getElementById('btn-generate-layout').addEventListener('click', generateAILayout);
            document.getElementById('btn-preview-layout').addEventListener('click', previewGeneratedLayout);
            
            // ü§ñ AI Training event listeners
            document.getElementById('btn-start-training').addEventListener('click', startTraining);
            document.getElementById('btn-training-status').addEventListener('click', getTrainingStatus);
            
            // üîó Custom Training event listeners
            document.getElementById('btn-add-custom-site').addEventListener('click', addCustomSite);
            document.getElementById('btn-train-custom').addEventListener('click', trainWithCustomSites);
            
            logMessage('üéõÔ∏è Button event listeners attached', 'info');
            
            // Auto check server status
            setTimeout(() => {
                getServerStatus();
            }, 1000);
        });
        
        // üóÑÔ∏è STORAGE ANALYTICS FUNCTIONS
        async function getStorageInfo() {
            try {
                logMessage('üóÑÔ∏è Getting storage information...', 'info');
                
                const response = await fetch(`${API_BASE}/api/training/history`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalSamples').textContent = data.totalSamples || 0;
                    document.getElementById('customSitesCount').textContent = data.customSitesCount || 0;
                    
                    logMessage(`üìä Storage Stats Retrieved:`, 'success');
                    logMessage(`  üìÅ Total Samples: ${data.totalSamples}`, 'info');
                    logMessage(`  üîó Custom Sites: ${data.customSitesCount}`, 'info');
                    logMessage(`  üè† Storage Location: ${data.storageLocation?.samples || 'N/A'}`, 'info');
                    
                    if (data.lastTrainingDate) {
                        const lastDate = new Date(data.lastTrainingDate).toLocaleDateString();
                        logMessage(`  üìÖ Last Training: ${lastDate}`, 'info');
                    }
                } else {
                    logMessage(`‚ùå Failed to get storage info: ${data.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Storage Info Error: ${error.message}`, 'error');
            }
        }
        
        async function getTrainingHistory() {
            try {
                logMessage('üìà Getting training history...', 'info');
                
                const response = await fetch(`${API_BASE}/api/training/history`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logMessage(`üìà Training History:`, 'success');
                    logMessage(`  üéØ Current Training ID: ${data.currentTraining?.trainingId || 'None'}`, 'info');
                    logMessage(`  ‚ö° Training Status: ${data.currentTraining?.isTraining ? 'Active' : 'Idle'}`, 'info');
                    logMessage(`  üìä Progress: ${data.currentTraining?.progress || 0}%`, 'info');
                    logMessage(`  üéØ Accuracy: ${data.currentTraining?.accuracy || 'N/A'}%`, 'info');
                    
                    if (data.samplesCollected && data.samplesCollected.length > 0) {
                        logMessage(`  üìÅ Sample IDs: ${data.samplesCollected.slice(0, 3).join(', ')}${data.samplesCollected.length > 3 ? '...' : ''}`, 'info');
                    }
                    
                    // Update UI counters
                    document.getElementById('totalSamples').textContent = data.totalSamples || 0;
                    document.getElementById('customSitesCount').textContent = data.customSitesCount || 0;
                    
                } else {
                    logMessage(`‚ùå Failed to get training history: ${data.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Training History Error: ${error.message}`, 'error');
            }
        }
        
        // üé® AI LAYOUT GENERATION FUNCTIONS
        let generatedLayout = null;
        
        async function generateAILayout() {
            try {
                const businessType = document.getElementById('generated-business-type').value;
                const style = document.getElementById('generated-style').value;
                const businessName = document.getElementById('business-name').value || `My ${businessType}`;
                
                logMessage(`üé® Generating AI layout for ${businessName} (${businessType} - ${style})...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/generate/layout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        businessType: businessType,
                        style: style,
                        businessName: businessName,
                        useTrainedModel: true, // Use the trained AI
                        currentBlocks: ['hero', 'about', 'services', 'contact'],
                        requirements: { 
                            mobileFirst: true,
                            accessibility: true,
                            trainedStyle: true
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    generatedLayout = data;
                    logMessage(`‚úÖ AI Layout Generated Successfully!`, 'success');
                    logMessage(`üéØ Semantic Score: ${data.semanticScore}/100`, 'info');
                    logMessage(`üß† AI Model Used: ${data.metadata?.aiModel || 'Trained Model'}`, 'info');
                    logMessage(`üìä Blocks Generated: ${data.layout?.length || 0}`, 'info');
                    
                    if (data.layout && data.layout.length > 0) {
                        logMessage(`üîß Generated Blocks: ${data.layout.join(', ')}`, 'info');
                    }
                    
                    // Update API calls counter
                    document.getElementById('apiCalls').textContent = parseInt(document.getElementById('apiCalls').textContent) + 1;
                    
                } else {
                    logMessage(`‚ùå Layout Generation Failed: ${data.error || data.message}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå AI Layout Generation Error: ${error.message}`, 'error');
            }
        }
        
        async function previewGeneratedLayout() {
            if (!generatedLayout) {
                logMessage('‚ùå No layout generated yet. Generate a layout first!', 'error');
                return;
            }
            
            try {
                logMessage('üëÄ Opening layout preview...', 'info');
                
                // Generate sections from AI blocks
                const generateSectionHTML = (blockName) => {
                    const blockMap = {
                        'navigation-elegant': `<nav style="background: rgba(255,255,255,0.95); padding: 1rem 0; position: fixed; width: 100%; top: 0; z-index: 1000;"><div class="container" style="display: flex; justify-content: space-between; align-items: center;"><div style="font-weight: bold; font-size: 1.2rem;">${generatedLayout.businessName}</div><div><a href="#about" style="margin: 0 1rem; text-decoration: none; color: #333;">About</a><a href="#services" style="margin: 0 1rem; text-decoration: none; color: #333;">Menu</a><a href="#contact" style="margin: 0 1rem; text-decoration: none; color: #333;">Contact</a></div></div></nav>`,
                        
                        'hero-restaurant': `<section class="hero" style="margin-top: 80px;"><div class="container"><h1>${generatedLayout.businessName}</h1><p>Layout generato dall'AI allenata - Stile: ${generatedLayout.style}</p><button style="background: white; color: #667eea; padding: 1rem 2rem; border: none; border-radius: 5px; font-size: 1.1rem; margin-top: 2rem; cursor: pointer;">Prenota Ora</button></div></section>`,
                        
                        'menu-showcase': `<section class="section" id="menu"><div class="container"><h2>üçΩÔ∏è Menu Speciali</h2><div class="grid"><div class="card"><h3>Antipasti Gourmet</h3><p>Selezione di antipasti preparati con ingredienti freschi e locali</p><span style="color: #667eea; font-weight: bold;">‚Ç¨15</span></div><div class="card"><h3>Primi Piatti</h3><p>Pasta fresca fatta in casa con sughi tradizionali</p><span style="color: #667eea; font-weight: bold;">‚Ç¨18</span></div><div class="card"><h3>Secondi di Carne</h3><p>Carni selezionate cotte alla griglia con contorni stagionali</p><span style="color: #667eea; font-weight: bold;">‚Ç¨25</span></div></div></div></section>`,
                        
                        'about-story': `<section class="section" id="about"><div class="container"><h2>La Nostra Storia</h2><p>Questo layout √® stato generato dall'AI dopo il training con i tuoi siti custom. Un ristorante che combina tradizione e innovazione, offrendo un'esperienza culinaria unica nel cuore della citt√†.</p></div></section>`,
                        
                        'gallery-food': `<section class="section"><div class="container"><h2>üì∏ Gallery Piatti</h2><div class="grid"><div class="card" style="background: linear-gradient(45deg, #ff6b6b, #feca57); color: white; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center;"><h3>ü•ó Piatto del Giorno</h3></div><div class="card" style="background: linear-gradient(45deg, #48cae4, #023e8a); color: white; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center;"><h3>üçù Pasta Fresca</h3></div><div class="card" style="background: linear-gradient(45deg, #f72585, #b5179e); color: white; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center;"><h3>ü•© Carne alla Griglia</h3></div></div></div></section>`,
                        
                        'reviews-customers': `<section class="section"><div class="container"><h2>‚≠ê Recensioni Clienti</h2><div class="grid"><div class="card"><h3>Marco R.</h3><p>"Esperienza fantastica! Il cibo √® delizioso e il servizio impeccabile. Consiglio vivamente!"</p><div style="color: #ffd700;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div></div><div class="card"><h3>Sofia M.</h3><p>"Ambiente accogliente e piatti creativi. Perfetto per una serata romantica."</p><div style="color: #ffd700;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div></div><div class="card"><h3>Andrea T.</h3><p>"Qualit√† eccellente e prezzi giusti. Torner√≤ sicuramente!"</p><div style="color: #ffd700;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div></div></div></div></section>`,
                        
                        'contact-reservation': `<section class="section" id="contact"><div class="container"><h2>üìû Contatti & Prenotazioni</h2><div class="grid"><div class="card"><h3>üìç Dove Siamo</h3><p>Via Roma 123<br>00100 Roma, Italia</p></div><div class="card"><h3>üìû Telefono</h3><p>+39 06 123 4567<br>Aperto: 19:00 - 23:30</p></div><div class="card"><h3>üìß Email</h3><p>info@${generatedLayout.businessName.toLowerCase().replace(/\s+/g, '')}.com</p></div></div></div></section>`,
                        
                        'footer-social': `<footer class="footer"><div class="container"><p>ü§ñ Generated by AI-Trainer | Score: ${generatedLayout.semanticScore}/100</p><div style="margin-top: 1rem;"><span style="margin: 0 1rem;">üìò Facebook</span><span style="margin: 0 1rem;">üì∑ Instagram</span><span style="margin: 0 1rem;">üê¶ Twitter</span></div></div></footer>`
                    };
                    
                    return blockMap[blockName] || `<section class="section"><div class="container"><h2>${blockName}</h2><p>Sezione generata dall'AI: ${blockName}</p></div></section>`;
                };
                
                // Generate HTML from AI blocks
                const sectionsHTML = generatedLayout.layout.map(block => generateSectionHTML(block)).join('\n');
                
                console.log('üîç Generated sections HTML:', sectionsHTML.substring(0, 500) + '...');
                logMessage(`üîß Generated ${generatedLayout.layout.length} dynamic sections`, 'info');
                
                // Create a preview HTML
                const previewHTML = `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generated Layout - ${generatedLayout.businessName || 'Preview'}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
        .hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4rem 0; text-align: center; }
        .hero h1 { font-size: 3rem; margin-bottom: 1rem; }
        .hero p { font-size: 1.2rem; opacity: 0.9; }
        .section { padding: 3rem 0; }
        .section:nth-child(even) { background: #f8f9fa; }
        .section h2 { font-size: 2rem; margin-bottom: 2rem; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem; }
        .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .footer { background: #1a202c; color: white; padding: 2rem 0; text-align: center; }
        .ai-badge { position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem; z-index: 1001; }
        a { color: inherit; text-decoration: none; }
        a:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <div class="ai-badge">ü§ñ AI Generated (${generatedLayout.style})</div>
    ${sectionsHTML}
</body>
</html>`;
                
                // Open in new window with blob URL
                const blob = new Blob([previewHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const previewWindow = window.open(url, '_blank');
                
                // Clean up blob URL after a delay
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                logMessage('‚úÖ Layout preview opened in new window', 'success');
                
            } catch (error) {
                logMessage(`‚ùå Preview Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
