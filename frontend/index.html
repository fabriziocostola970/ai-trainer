<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Trainer Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #f8fafc; 
            line-height: 1.6;
        }
        
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #48bb78;
            margin-right: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #667EEA;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .action-card {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-card h3 {
            margin-bottom: 1rem;
            color: #1a202c;
        }
        
        .action-card p {
            color: #718096;
            margin-bottom: 1rem;
        }
        
        .btn {
            background: #667EEA;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
            margin: 0.5rem 0.5rem 0.5rem 0;
            font-size: 0.9rem;
        }
        
        .btn:hover { 
            background: #5a5fcf; 
            transform: translateY(-1px);
        }
        
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .log div {
            margin: 0.25rem 0;
        }
        
        .success { color: #48bb78; }
        .error { color: #f56565; }
        .info { color: #63b3ed; }
        
        @media (max-width: 768px) {
            .dashboard { padding: 1rem; }
            .header h1 { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .actions { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ü§ñ AI-Trainer Dashboard</h1>
            <p>Template Intelligence Engine</p>
            <p><span class="status-indicator"></span> Sistema Operativo</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="serverStatus">‚è≥</div>
                <div class="stat-label">Server Status</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="apiCalls">0</div>
                <div class="stat-label">API Calls Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="templateCount">156</div>
                <div class="stat-label">Templates Generated</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="accuracyScore">94%</div>
                <div class="stat-label">Accuracy Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="colorPalettes">‚è≥</div>
                <div class="stat-label">üé® Color Palettes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="fontCombos">‚è≥</div>
                <div class="stat-label">üìù Font Combos</div>
            </div>
        </div>
        
        <div class="actions">
            <div class="action-card">
                <h3>üé® Template Generation</h3>
                <p>Genera layout intelligenti per business specifici</p>
                <button class="btn" id="btn-layout-generation">Test Layout Generation</button>
                <button class="btn" id="btn-template-creation">Test Template Creation</button>
            </div>
            
            <div class="action-card">
                <h3>üìä System Monitoring</h3>
                <p>Controlla stato sistema e performance</p>
                <button class="btn" id="btn-server-status">Check Server Status</button>
                <button class="btn" id="btn-health-check">Health Check</button>
            </div>
            
            <div class="action-card">
                <h3>üîß Debug Tools</h3>
                <p>Strumenti per testing e debug</p>
                <button class="btn" id="btn-test-api">Test Full API</button>
                <button class="btn" id="btn-clear-logs">Clear Logs</button>
            </div>
            
            <div class="action-card">
                <h3>üóëÔ∏è Database Management</h3>
                <p>Gestione e pulizia database training</p>
                <button class="btn btn-danger" id="btn-clear-patterns" style="background: #e53e3e; margin-bottom: 0.5rem;">
                    üóëÔ∏è Clear ai_design_patterns
                </button>
                <div style="font-size: 0.8rem; color: #e53e3e; margin-top: 0.5rem;">
                    ‚ö†Ô∏è ATTENZIONE: Cancella tutti i dati di training!
                </div>
            </div>
            
            <div class="action-card">
                <h3>üóÑÔ∏è Storage Analytics</h3>
                <p>Visualizza informazioni su dati e storage</p>
                <button class="btn" id="btn-storage-info">Storage Stats</button>
                <button class="btn" id="btn-training-history">Training History</button>
                <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div style="text-align: center; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                        <div style="font-weight: bold; color: #667EEA;" id="totalSamples">-</div>
                        <div style="font-size: 0.8rem; color: #666;">Total Samples</div>
                    </div>
                    <div style="text-align: center; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                        <div style="font-weight: bold; color: #667EEA;" id="customSitesCount">-</div>
                        <div style="font-size: 0.8rem; color: #666;">Custom Sites</div>
                    </div>
                </div>
            </div>
            
            <div class="action-card">
                <h3>üé® Generate New Layout</h3>
                <p>Testa l'AI allenata - Genera layout con stili appresi</p>
                <div style="margin: 1rem 0;">
                    <select id="generated-business-type" style="width: 48%; padding: 0.5rem; margin-right: 4%; margin-bottom: 0.5rem;">
                        <option value="restaurant">Restaurant</option>
                        <option value="tech-startup">Tech Startup</option>
                        <option value="ecommerce">E-commerce</option>
                        <option value="portfolio">Portfolio</option>
                        <option value="wellness">Wellness</option>
                        <option value="real-estate">Real Estate</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="generated-style" style="width: 48%; padding: 0.5rem; margin-bottom: 0.5rem;">
                        <option value="minimal">Minimal (AI Learned)</option>
                        <option value="elegant">Elegant (AI Learned)</option>
                        <option value="casual">Casual (AI Learned)</option>
                        <option value="creative">Creative (AI Learned)</option>
                        <option value="professional">Professional (AI Learned)</option>
                    </select>
                    <input type="text" id="business-name" placeholder="Nome Business (es: My Restaurant)" 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                </div>
                <button class="btn" id="btn-generate-layout" style="background: #10b981;">üé® Generate AI Layout</button>
                <button class="btn" id="btn-preview-layout">üëÄ Preview Generated</button>
            </div>

            <div class="action-card">
                <h3>ü§ñ AI Training</h3>
                <p>Avvia training AI con dataset reale</p>
                <button class="btn" id="btn-start-training" style="background: #e74c3c;">Start Training Collection</button>
                <button class="btn" id="btn-training-status">Training Status</button>
            </div>
            
            <div class="action-card">
                <h3>üîó Custom Training</h3>
                <p>Allena l'AI con i tuoi siti preferiti</p>
                <div style="margin: 1rem 0;">
                    <input type="url" id="custom-url" placeholder="https://example.com" 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                    <select id="business-type" style="width: 48%; padding: 0.5rem; margin-right: 4%;">
                        <option value="restaurant">Restaurant</option>
                        <option value="tech-startup">Tech Startup</option>
                        <option value="ecommerce">E-commerce</option>
                        <option value="portfolio">Portfolio</option>
                        <option value="wellness">Wellness</option>
                        <option value="real-estate">Real Estate</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="style-type" style="width: 48%; padding: 0.5rem;">
                        <option value="minimal">Minimal</option>
                        <option value="elegant">Elegant</option>
                        <option value="casual">Casual</option>
                        <option value="creative">Creative</option>
                        <option value="professional">Professional</option>
                    </select>
                </div>
                <button class="btn" id="btn-add-custom-site">Add Site to Training</button>
                <button class="btn" id="btn-train-custom" style="background: #27ae60;">Train with Custom Sites</button>
            </div>
            
            <div class="action-card">
                <h3>üöÄ Auto Complete Training</h3>
                <p>Training automatico completo: raccolta + estrazione + analisi + export in un click</p>
                <div style="margin: 1rem 0;">
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #495057;">ü§ñ Processo Completamente Automatico:</h4>
                        <div style="font-size: 0.85rem; color: #6c757d; line-height: 1.4;">
                            1. üöÄ <strong>Raccolta HTML</strong> da 5 siti diversi<br>
                            2. üé® <strong>Estrazione CSS</strong> automatica durante analisi<br>
                            3. üåà <strong>Analisi Colori</strong> e palette vincenti<br>
                            4. üìù <strong>Analisi Font</strong> e combinazioni tipografiche<br>
                            5. üß† <strong>Classificazione</strong> automatica per business type<br>
                            6. üì¶ <strong>Export CSS Library</strong> pronta all'uso
                        </div>
                    </div>
                    
                    <!-- Site Selection Section -->
                    <div style="background: #e8f5e8; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #2d5a2d;">üåê Selezione Siti per Training:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                            <select id="training-business-type" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="restaurant">Restaurant</option>
                                <option value="ecommerce">E-commerce</option>
                                <option value="tech-startup">Tech Startup</option>
                                <option value="portfolio">Portfolio</option>
                                <option value="real-estate">Real Estate</option>
                                <option value="wellness">Wellness</option>
                                <option value="mixed">Mixed (Diversi Tipi)</option>
                            </select>
                            <select id="training-region" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="global">Global Sites</option>
                                <option value="italy">Italian Sites</option>
                                <option value="europe">European Sites</option>
                                <option value="usa">USA Sites</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button class="btn" id="btn-generate-sites" style="background: #10b981; flex: 1;">
                                ü§ñ Genera 5 Siti con OpenAI
                            </button>
                            <button class="btn" id="btn-use-default-sites" style="background: #6b7280; flex: 1;">
                                üìã Usa Siti di Default
                            </button>
                        </div>
                        <div id="selected-sites" style="background: white; padding: 0.75rem; border-radius: 4px; border: 1px solid #ddd; min-height: 120px;">
                            <div style="font-weight: bold; margin-bottom: 0.5rem; color: #4b5563;">üéØ Siti Selezionati per Training:</div>
                            <div id="sites-list" style="font-size: 0.85rem; color: #6b7280;">
                                Clicca "Genera 5 Siti con OpenAI" per ottenere suggerimenti personalizzati
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="btn" id="btn-auto-classify" style="background: #6f42c1; flex: 1;">
                            üß† Test Auto-Classification
                        </button>
                        <button class="btn" id="btn-batch-train" style="background: #fd7e14; flex: 1;">
                            üöÄ Auto Train Complete (5 Sites)
                        </button>
                    </div>
                    <div id="batch-progress" style="display: none; background: #e3f2fd; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">üìä Auto Training Progress:</div>
                        <div id="batch-status">Initializing complete process...</div>
                        <div style="background: #fff; border-radius: 3px; height: 8px; margin-top: 0.5rem; overflow: hidden;">
                            <div id="batch-progress-bar" style="background: #2196f3; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="batch-steps" style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                            <div id="step-collect">‚è≥ Step 1: Collecting HTML from 5 sites...</div>
                            <div id="step-extract" style="opacity: 0.5;">‚è≥ Step 2: Extracting CSS and colors...</div>
                            <div id="step-analyze" style="opacity: 0.5;">‚è≥ Step 3: Analyzing fonts and patterns...</div>
                            <div id="step-classify" style="opacity: 0.5;">‚è≥ Step 4: Auto-classifying samples...</div>
                            <div id="step-export" style="opacity: 0.5;">‚è≥ Step 5: Exporting CSS library...</div>
                            <div id="step-complete" style="opacity: 0.5;">‚è≥ Step 6: Process complete!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="actions" style="margin-top: 2rem;">
            <div class="action-card">
                <h3>üé® Design Intelligence Engine</h3>
                <p>Estrazione automatica di CSS, font e pattern dai siti analizzati</p>
                <div style="margin: 1rem 0;">
                    <div style="background: #e3f2fd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #1565c0;">üß† Estrazione Automatica durante Training:</h4>
                        <div style="font-size: 0.85rem; color: #1565c0; line-height: 1.4;">
                            üé® <strong>CSS Extraction:</strong> Estrae automaticamente stili CSS durante analisi<br>
                            üåà <strong>Color Palette Mining:</strong> Identifica palette dominanti e armoniose<br>
                            üìù <strong>Font Intelligence:</strong> Rileva combinazioni tipografiche vincenti<br>
                            üìê <strong>Layout Pattern Recognition:</strong> Cattura strutture e pattern di design<br>
                            üéØ <strong>Auto-Classification:</strong> Classifica automaticamente per business type
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="btn" id="btn-extract-library" style="background: #2196f3; flex: 1;">
                            ÔøΩ Extract Design Library
                        </button>
                        <button class="btn" id="btn-analyze-patterns" style="background: #3f51b5; flex: 1;">
                            ÔøΩ Analyze Stored Patterns
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="btn" id="btn-classify-samples" style="background: #673ab7; flex: 1;">
                            üß† Classify Training Samples
                        </button>
                        <button class="btn" id="btn-export-library" style="background: #009688; flex: 1;">
                            ÔøΩ Export CSS Library
                        </button>
                    </div>
                    <div id="extraction-stats" style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">üìä Extracted Design Library:</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: #2196f3;" id="extractedCSS">0</div>
                                <div style="font-size: 0.8rem; color: #666;">CSS Themes</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: #e91e63;" id="extractedColors">0</div>
                                <div style="font-size: 0.8rem; color: #666;">Color Palettes</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: #9c27b0;" id="extractedFonts">0</div>
                                <div style="font-size: 0.8rem; color: #666;">Font Combos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: #ff9800;" id="extractedPatterns">0</div>
                                <div style="font-size: 0.8rem; color: #666;">Layout Patterns</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="action-card" style="margin-top: 2rem;">
            <h3>üìã System Logs</h3>
            <div id="logs" class="log">
                <div class="info">üöÄ AI-Trainer Dashboard Initialized</div>
                <div class="success">‚úÖ Interface: Pure HTML (No React Issues)</div>
                <div class="info">üîÑ Checking server connection...</div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_KEY = 'ai-trainer-1e212623176704eea6dba3b62117d36c0f64d6512419defdd25226294c45a90d';
        const API_BASE = window.location.origin;
        
        // üö® ALERT SYSTEM
        let alertCheckInterval = null;
        
        async function checkForCriticalAlerts() {
            try {
                const response = await fetch(`${API_BASE}/api/training/alerts`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                const data = await response.json();
                
                if (data.success && data.hasAlert && data.alert) {
                    showCriticalAlert(data.alert);
                }
            } catch (error) {
                console.error('Failed to check for alerts:', error);
            }
        }
        
        function showCriticalAlert(alertData) {
            // Create alert modal
            const alertModal = document.createElement('div');
            alertModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            alertModal.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 1rem;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                ">
                    <h2 style="color: #dc2626; margin-bottom: 1rem; font-size: 1.5rem;">
                        üö® Critical Error Alert
                    </h2>
                    <div style="margin-bottom: 1rem;">
                        <strong>Type:</strong> ${alertData.type}<br>
                        <strong>Time:</strong> ${new Date(alertData.timestamp).toLocaleString()}<br>
                        <strong>Message:</strong> ${alertData.message}
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; max-height: 200px; overflow-y: auto;">
                        <strong>Error Details:</strong><br>
                        <pre style="font-size: 0.8rem; white-space: pre-wrap;">${JSON.stringify(alertData.details, null, 2)}</pre>
                    </div>
                    <div style="text-align: right;">
                        <button onclick="clearCriticalAlert()" style="
                            background: #dc2626;
                            color: white;
                            border: none;
                            padding: 0.75rem 1.5rem;
                            border-radius: 0.5rem;
                            cursor: pointer;
                            margin-right: 0.5rem;
                        ">Close & Clear Alert</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                            background: #6b7280;
                            color: white;
                            border: none;
                            padding: 0.75rem 1.5rem;
                            border-radius: 0.5rem;
                            cursor: pointer;
                        ">Close Only</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(alertModal);
            
            // Log the error
            logMessage(`üö® CRITICAL ERROR: ${alertData.type} - ${alertData.message}`, 'error');
        }
        
        async function clearCriticalAlert() {
            try {
                await fetch(`${API_BASE}/api/training/alerts/clear`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                
                // Remove all alert modals
                document.querySelectorAll('[style*="position: fixed"]').forEach(modal => {
                    if (modal.style.zIndex === '10000') {
                        modal.remove();
                    }
                });
                
                logMessage('‚úÖ Critical alert cleared', 'success');
            } catch (error) {
                logMessage(`‚ùå Failed to clear alert: ${error.message}`, 'error');
            }
        }
        
        // Start alert checking when page loads
        function startAlertMonitoring() {
            if (alertCheckInterval) clearInterval(alertCheckInterval);
            alertCheckInterval = setInterval(checkForCriticalAlerts, 10000); // Check every 10 seconds
            checkForCriticalAlerts(); // Check immediately
        }
        
        // Logging function
        function logMessage(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logs.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        // API Functions
        async function getServerStatus() {
            try {
                logMessage('üîç Checking server status...');
                const response = await fetch(`${API_BASE}/status`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                const data = await response.json();
                logMessage(`‚úÖ Server Status: Online`, 'success');
                logMessage(`üìä Version: ${data.version}`, 'info');
                document.getElementById('serverStatus').textContent = response.ok ? '‚úÖ' : '‚ùå';
            } catch (error) {
                logMessage(`‚ùå Server Status Error: ${error.message}`, 'error');
                document.getElementById('serverStatus').textContent = '‚ùå';
            }
        }
        
        async function getHealthCheck() {
            try {
                logMessage('ü©∫ Running health check...');
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                logMessage(`‚úÖ Health Check: ${data.status}`, 'success');
                logMessage(`üîß Service: ${data.service}`, 'info');
            } catch (error) {
                logMessage(`‚ùå Health Check Error: ${error.message}`, 'error');
            }
        }
        
        async function testLayoutGeneration() {
            try {
                logMessage('üé® Testing layout generation...');
                const response = await fetch(`${API_BASE}/api/generate/layout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        businessType: 'restaurant',
                        currentBlocks: ['hero', 'about', 'menu', 'contact'],
                        requirements: { mobileFirst: true }
                    })
                });
                const data = await response.json();
                if (data.success) {
                    logMessage(`üé® Layout Generated: Score ${data.semanticScore}/100`, 'success');
                    document.getElementById('apiCalls').textContent = parseInt(document.getElementById('apiCalls').textContent) + 1;
                } else {
                    logMessage(`‚ö†Ô∏è Layout Generation: ${data.message}`, 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Layout Generation Error: ${error.message}`, 'error');
            }
        }
        
        async function testTemplateCreation() {
            try {
                logMessage('üñºÔ∏è Testing template creation...');
                const response = await fetch(`${API_BASE}/api/validate/template`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        template: { name: 'Test Template', blocks: ['hero', 'features'] },
                        businessType: 'tech-startup'
                    })
                });
                const data = await response.json();
                if (data.isValid) {
                    logMessage(`üñºÔ∏è Template Valid: Score ${data.scores?.creativity || 'N/A'}/100`, 'success');
                    document.getElementById('apiCalls').textContent = parseInt(document.getElementById('apiCalls').textContent) + 1;
                } else {
                    logMessage(`‚ö†Ô∏è Template Validation: Issues found`, 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Template Creation Error: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            logMessage('üîÑ Running full API test suite...');
            await getHealthCheck();
            await getServerStatus();
            await testLayoutGeneration();
            await testTemplateCreation();
            logMessage('‚úÖ Full API test completed', 'success');
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="info">üßπ Logs cleared</div>';
        }
        
        // üóëÔ∏è DATABASE MANAGEMENT FUNCTIONS
        async function clearDesignPatterns() {
            // Conferma utente prima di cancellare
            if (!confirm('‚ö†Ô∏è ATTENZIONE!\n\nQuesto canceller√† TUTTI i dati dalla tabella ai_design_patterns.\nVuoi davvero continuare?')) {
                return;
            }
            
            try {
                logMessage('üóëÔ∏è Cancellazione tabella ai_design_patterns...', 'info');
                
                const response = await fetch(`${API_BASE}/api/db-admin/clear-patterns`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    logMessage(`‚úÖ Tabella cancellata! Eliminati ${result.deletedCount} record`, 'success');
                    
                    // Aggiorna le statistiche
                    await getStorageInfo();
                    
                } else {
                    const error = await response.text();
                    logMessage(`‚ùå Errore cancellazione: ${error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Errore di rete: ${error.message}`, 'error');
            }
        }
        
        // ü§ñ AI TRAINING FUNCTIONS
        async function startTraining() {
            try {
                logMessage('üöÄ Starting AI training collection...', 'info');
                logMessage('‚ö†Ô∏è This will take 10-15 minutes and cost $30-80', 'info');
                
                const response = await fetch(`${API_BASE}/api/training/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        samples: 8, // Start with 8 samples
                        aiAnalysis: true,
                        saveLocal: true
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    logMessage(`üéØ Training started: ${data.trainingId}`, 'success');
                    logMessage(`üìä Collecting ${data.samplesCount} samples`, 'info');
                    // Poll for progress updates
                    pollTrainingProgress(data.trainingId);
                } else {
                    logMessage(`‚ùå Training start failed: ${data.error}`, 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Training Error: ${error.message}`, 'error');
            }
        }
        
        async function getTrainingStatus() {
            try {
                logMessage('üìä Checking training status...', 'info');
                const response = await fetch(`${API_BASE}/api/training/status`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                const data = await response.json();
                
                if (data.isTraining) {
                    logMessage(`üîÑ Training in progress: ${data.progress}%`, 'info');
                    logMessage(`üìà Samples collected: ${data.samplesCollected}/${data.totalSamples}`, 'info');
                } else {
                    logMessage(`‚úÖ Training completed: ${data.modelAccuracy}% accuracy`, 'success');
                }
            } catch (error) {
                logMessage(`‚ùå Status check failed: ${error.message}`, 'error');
            }
        }
        
        function pollTrainingProgress(trainingId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/training/progress/${trainingId}`, {
                        headers: { 'Authorization': `Bearer ${API_KEY}` }
                    });
                    const data = await response.json();
                    
                    logMessage(`üìà Progress: ${data.progress}% - ${data.currentStep}`, 'info');
                    
                    if (data.completed) {
                        clearInterval(interval);
                        logMessage('üéâ Training completed successfully!', 'success');
                        logMessage(`üéØ Final accuracy: ${data.accuracy}%`, 'success');
                    }
                } catch (error) {
                    clearInterval(interval);
                    logMessage(`‚ùå Progress polling failed: ${error.message}`, 'error');
                }
            }, 10000); // Poll every 10 seconds
        }
        
        // üîó CUSTOM TRAINING FUNCTIONS
        let customSites = [];
        
        function addCustomSite() {
            const url = document.getElementById('custom-url').value;
            const businessType = document.getElementById('business-type').value;
            const styleType = document.getElementById('style-type').value;
            
            if (!url) {
                logMessage('‚ùå Please enter a valid URL', 'error');
                return;
            }
            
            const customSite = {
                url: url,
                businessType: businessType,
                style: styleType,
                targetAudience: 'custom-defined',
                addedAt: new Date().toISOString()
            };
            
            customSites.push(customSite);
            logMessage(`‚úÖ Added: ${url} (${businessType} - ${styleType})`, 'success');
            logMessage(`üìä Custom sites queue: ${customSites.length}`, 'info');
            
            // Clear inputs
            document.getElementById('custom-url').value = '';
        }
        
        async function trainWithCustomSites() {
            if (customSites.length === 0) {
                logMessage('‚ùå No custom sites added. Add some sites first!', 'error');
                return;
            }
            
            try {
                logMessage(`üöÄ Starting custom training with ${customSites.length} sites...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/training/custom`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        customSites: customSites,
                        aiAnalysis: true,
                        saveLocal: true
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    logMessage(`üéØ Custom training started: ${data.trainingId}`, 'success');
                    logMessage(`üìä Processing ${data.sitesCount} custom sites`, 'info');
                    pollTrainingProgress(data.trainingId);
                    customSites = []; // Clear queue after starting
                } else {
                    logMessage(`‚ùå Custom training failed: ${data.error}`, 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Custom Training Error: ${error.message}`, 'error');
            }
        }
        
        // ü§ñ OPENAI SITE GENERATION FUNCTIONS
        let selectedTrainingSites = [];
        
        async function generateSitesWithOpenAI() {
            try {
                const businessType = document.getElementById('training-business-type').value;
                const region = document.getElementById('training-region').value;
                const sitesListDiv = document.getElementById('sites-list');
                
                sitesListDiv.innerHTML = '‚è≥ Generando siti con OpenAI...';
                logMessage('ü§ñ Requesting site suggestions from OpenAI...', 'info');
                
                // Chiamata all'endpoint OpenAI per generare siti
                const response = await fetch(`${API_BASE}/api/training/generate-sites`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        businessType: businessType,
                        region: region,
                        count: 5,
                        requirements: {
                            diverse: true,
                            wellKnown: true,
                            goodDesign: true,
                            responsive: true
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.sites) {
                    selectedTrainingSites = data.sites;
                    displaySelectedSites(data.sites);
                    logMessage(`‚úÖ Generated ${data.sites.length} sites with OpenAI`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to generate sites');
                }
                
            } catch (error) {
                logMessage(`‚ùå OpenAI Site Generation Error: ${error.message}`, 'error');
                document.getElementById('sites-list').innerHTML = `‚ùå Errore: ${error.message}<br><em>Usa "Siti di Default" come fallback</em>`;
            }
        }
        
        function useDefaultSites() {
            const businessType = document.getElementById('training-business-type').value;
            
            // Siti di default per diversi business types
            const defaultSites = {
                restaurant: [
                    { url: 'https://www.starbucks.com', name: 'Starbucks', description: 'Global coffee chain' },
                    { url: 'https://www.mcdonalds.com', name: 'McDonald\'s', description: 'Fast food restaurant' },
                    { url: 'https://www.pizzahut.com', name: 'Pizza Hut', description: 'Pizza restaurant chain' },
                    { url: 'https://www.kfc.com', name: 'KFC', description: 'Fried chicken restaurant' },
                    { url: 'https://www.subway.com', name: 'Subway', description: 'Sandwich restaurant' }
                ],
                ecommerce: [
                    { url: 'https://www.amazon.com', name: 'Amazon', description: 'Online marketplace' },
                    { url: 'https://www.nike.com', name: 'Nike', description: 'Sportswear brand' },
                    { url: 'https://www.etsy.com', name: 'Etsy', description: 'Handmade marketplace' },
                    { url: 'https://www.zara.com', name: 'Zara', description: 'Fashion retailer' },
                    { url: 'https://www.apple.com', name: 'Apple', description: 'Technology products' }
                ],
                'tech-startup': [
                    { url: 'https://www.stripe.com', name: 'Stripe', description: 'Payment processing' },
                    { url: 'https://www.slack.com', name: 'Slack', description: 'Team communication' },
                    { url: 'https://www.notion.so', name: 'Notion', description: 'Productivity workspace' },
                    { url: 'https://www.figma.com', name: 'Figma', description: 'Design tool' },
                    { url: 'https://www.vercel.com', name: 'Vercel', description: 'Web deployment' }
                ],
                mixed: [
                    { url: 'https://www.apple.com', name: 'Apple', description: 'Technology (ecommerce)' },
                    { url: 'https://www.starbucks.com', name: 'Starbucks', description: 'Restaurant (coffee)' },
                    { url: 'https://www.airbnb.com', name: 'Airbnb', description: 'Travel (marketplace)' },
                    { url: 'https://www.stripe.com', name: 'Stripe', description: 'Tech (fintech)' },
                    { url: 'https://www.nike.com', name: 'Nike', description: 'Fashion (ecommerce)' }
                ]
            };
            
            selectedTrainingSites = defaultSites[businessType] || defaultSites.mixed;
            displaySelectedSites(selectedTrainingSites);
            logMessage(`‚úÖ Using ${selectedTrainingSites.length} default sites for ${businessType}`, 'success');
        }
        
        function displaySelectedSites(sites) {
            const sitesListDiv = document.getElementById('sites-list');
            
            const sitesHTML = sites.map((site, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #e5e7eb; ${index === sites.length - 1 ? 'border-bottom: none;' : ''}">
                    <div>
                        <strong style="color: #1f2937;">${site.name || extractDomainName(site.url)}</strong>
                        <div style="font-size: 0.75rem; color: #6b7280;">${site.url}</div>
                        <div style="font-size: 0.7rem; color: #9ca3af; font-style: italic;">${site.description || 'Website for training'}</div>
                    </div>
                    <div style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem;">
                        ‚úì Selected
                    </div>
                </div>
            `).join('');
            
            sitesListDiv.innerHTML = sitesHTML;
        }
        
        function extractDomainName(url) {
            try {
                const domain = new URL(url).hostname;
                return domain.replace('www.', '').split('.')[0];
            } catch {
                return 'Website';
            }
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            logMessage('üöÄ Dashboard initialized successfully', 'success');
            logMessage('üì° No React dependencies - Pure HTML', 'info');
            
            // Setup event listeners for buttons (CSP-compliant)
            document.getElementById('btn-layout-generation').addEventListener('click', testLayoutGeneration);
            document.getElementById('btn-template-creation').addEventListener('click', testTemplateCreation);
            document.getElementById('btn-server-status').addEventListener('click', getServerStatus);
            document.getElementById('btn-health-check').addEventListener('click', getHealthCheck);
            document.getElementById('btn-test-api').addEventListener('click', testAPI);
            document.getElementById('btn-clear-logs').addEventListener('click', clearLogs);
            
            // ÔøΩÔ∏è Database Management event listeners  
            document.getElementById('btn-clear-patterns').addEventListener('click', clearDesignPatterns);
            
            // ÔøΩüóÑÔ∏è Storage Analytics event listeners
            document.getElementById('btn-storage-info').addEventListener('click', getStorageInfo);
            document.getElementById('btn-training-history').addEventListener('click', getTrainingHistory);
            
            // üé® AI Layout Generation event listeners
            document.getElementById('btn-generate-layout').addEventListener('click', generateAILayout);
            document.getElementById('btn-preview-layout').addEventListener('click', previewGeneratedLayout);
            
            // ü§ñ AI Training event listeners
            document.getElementById('btn-start-training').addEventListener('click', startTraining);
            document.getElementById('btn-training-status').addEventListener('click', getTrainingStatus);
            
            // üîó Custom Training event listeners
            document.getElementById('btn-add-custom-site').addEventListener('click', addCustomSite);
            document.getElementById('btn-train-custom').addEventListener('click', trainWithCustomSites);
            
            // üöÄ Batch Auto-Training event listeners
            document.getElementById('btn-auto-classify').addEventListener('click', testAutoClassification);
            document.getElementById('btn-batch-train').addEventListener('click', startBatchTraining);
            document.getElementById('btn-generate-sites').addEventListener('click', generateSitesWithOpenAI);
            document.getElementById('btn-use-default-sites').addEventListener('click', useDefaultSites);
            
            // üé® Design Intelligence Engine event listeners
            document.getElementById('btn-extract-library').addEventListener('click', extractDesignLibrary);
            document.getElementById('btn-analyze-patterns').addEventListener('click', analyzeStoredPatterns);
            document.getElementById('btn-classify-samples').addEventListener('click', classifyTrainingSamples);
            document.getElementById('btn-export-library').addEventListener('click', exportCSSLibrary);
            
            logMessage('üéõÔ∏è Button event listeners attached', 'info');
            
            // Auto check server status
            setTimeout(() => {
                getServerStatus();
            }, 1000);
            
            // üé® Auto load extraction stats
            setTimeout(() => {
                loadExtractionStats();
                logMessage('üé® Design extraction stats monitoring started', 'info');
            }, 3000);
            
            // üö® Start alert monitoring
            setTimeout(() => {
                startAlertMonitoring();
                logMessage('üö® Critical alert monitoring started', 'info');
            }, 2000);
        });
        
        // üóÑÔ∏è STORAGE ANALYTICS FUNCTIONS
        async function getStorageInfo() {
            try {
                logMessage('üóÑÔ∏è Getting storage information...', 'info');
                
                const response = await fetch(`${API_BASE}/api/training/history`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalSamples').textContent = data.totalSamples || 0;
                    document.getElementById('customSitesCount').textContent = data.customSitesCount || 0;
                    
                    logMessage(`üìä Storage Stats Retrieved:`, 'success');
                    logMessage(`  üìÅ Total Samples: ${data.totalSamples}`, 'info');
                    logMessage(`  üîó Custom Sites: ${data.customSitesCount}`, 'info');
                    logMessage(`  üè† Storage Location: ${data.storageLocation?.samples || 'N/A'}`, 'info');
                    
                    if (data.lastTrainingDate) {
                        const lastDate = new Date(data.lastTrainingDate).toLocaleDateString();
                        logMessage(`  üìÖ Last Training: ${lastDate}`, 'info');
                    }
                } else {
                    logMessage(`‚ùå Failed to get storage info: ${data.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Storage Info Error: ${error.message}`, 'error');
            }
        }
        
        async function getTrainingHistory() {
            try {
                logMessage('üìà Getting training history...', 'info');
                
                const response = await fetch(`${API_BASE}/api/training/history`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logMessage(`üìà Training History:`, 'success');
                    logMessage(`  üéØ Current Training ID: ${data.currentTraining?.trainingId || 'None'}`, 'info');
                    logMessage(`  ‚ö° Training Status: ${data.currentTraining?.isTraining ? 'Active' : 'Idle'}`, 'info');
                    logMessage(`  üìä Progress: ${data.currentTraining?.progress || 0}%`, 'info');
                    logMessage(`  üéØ Accuracy: ${data.currentTraining?.accuracy || 'N/A'}%`, 'info');
                    
                    if (data.samplesCollected && data.samplesCollected.length > 0) {
                        logMessage(`  üìÅ Sample IDs: ${data.samplesCollected.slice(0, 3).join(', ')}${data.samplesCollected.length > 3 ? '...' : ''}`, 'info');
                    }
                    
                    // Update UI counters
                    document.getElementById('totalSamples').textContent = data.totalSamples || 0;
                    document.getElementById('customSitesCount').textContent = data.customSitesCount || 0;
                    
                } else {
                    logMessage(`‚ùå Failed to get training history: ${data.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Training History Error: ${error.message}`, 'error');
            }
        }
        
        // üé® AI LAYOUT GENERATION FUNCTIONS
        let generatedLayout = null;
        
        async function generateAILayout() {
            try {
                const businessType = document.getElementById('generated-business-type').value;
                const style = document.getElementById('generated-style').value;
                const businessName = document.getElementById('business-name').value || `My ${businessType}`;
                
                logMessage(`üé® Generating AI layout for ${businessName} (${businessType} - ${style})...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/generate/layout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        businessType: businessType,
                        style: style,
                        businessName: businessName,
                        useTrainedModel: true, // Use the trained AI
                        currentBlocks: ['hero', 'about', 'services', 'contact'],
                        requirements: { 
                            mobileFirst: true,
                            accessibility: true,
                            trainedStyle: true
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    generatedLayout = data;
                    logMessage(`‚úÖ AI Layout Generated Successfully!`, 'success');
                    logMessage(`üéØ Semantic Score: ${data.semanticScore}/100`, 'info');
                    logMessage(`üß† AI Model Used: ${data.metadata?.aiModel || 'Trained Model'}`, 'info');
                    logMessage(`üìä Blocks Generated: ${data.layout?.length || 0}`, 'info');
                    
                    if (data.layout && data.layout.length > 0) {
                        logMessage(`üîß Generated Blocks: ${data.layout.join(', ')}`, 'info');
                    }
                    
                    // Update API calls counter
                    document.getElementById('apiCalls').textContent = parseInt(document.getElementById('apiCalls').textContent) + 1;
                    
                } else {
                    logMessage(`‚ùå Layout Generation Failed: ${data.error || data.message}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå AI Layout Generation Error: ${error.message}`, 'error');
            }
        }
        
        async function previewGeneratedLayout() {
            if (!generatedLayout) {
                logMessage('‚ùå No layout generated yet. Generate a layout first!', 'error');
                return;
            }
            
            try {
                logMessage('üëÄ Opening layout preview...', 'info');
                
                // Generate sections from AI blocks
                const generateSectionHTML = (blockName) => {
                    const blockMap = {
                        'navigation-elegant': `<nav style="background: rgba(255,255,255,0.95); padding: 1rem 0; position: fixed; width: 100%; top: 0; z-index: 1000;"><div class="container" style="display: flex; justify-content: space-between; align-items: center;"><div style="font-weight: bold; font-size: 1.2rem;">${generatedLayout.businessName}</div><div><a href="#about" style="margin: 0 1rem; text-decoration: none; color: #333;">About</a><a href="#services" style="margin: 0 1rem; text-decoration: none; color: #333;">Menu</a><a href="#contact" style="margin: 0 1rem; text-decoration: none; color: #333;">Contact</a></div></div></nav>`,
                        
                        'hero-restaurant': `<section class="hero" style="margin-top: 80px;"><div class="container"><h1>${generatedLayout.businessName}</h1><p>Layout generato dall'AI allenata - Stile: ${generatedLayout.style}</p><button style="background: white; color: #667eea; padding: 1rem 2rem; border: none; border-radius: 5px; font-size: 1.1rem; margin-top: 2rem; cursor: pointer;">Prenota Ora</button></div></section>`,
                        
                        'menu-showcase': `<section class="section" id="menu"><div class="container"><h2>üçΩÔ∏è Menu Speciali</h2><div class="grid"><div class="card"><h3>Antipasti Gourmet</h3><p>Selezione di antipasti preparati con ingredienti freschi e locali</p><span style="color: #667eea; font-weight: bold;">‚Ç¨15</span></div><div class="card"><h3>Primi Piatti</h3><p>Pasta fresca fatta in casa con sughi tradizionali</p><span style="color: #667eea; font-weight: bold;">‚Ç¨18</span></div><div class="card"><h3>Secondi di Carne</h3><p>Carni selezionate cotte alla griglia con contorni stagionali</p><span style="color: #667eea; font-weight: bold;">‚Ç¨25</span></div></div></div></section>`,
                        
                        'about-story': `<section class="section" id="about"><div class="container"><h2>La Nostra Storia</h2><p>Questo layout √® stato generato dall'AI dopo il training con i tuoi siti custom. Un ristorante che combina tradizione e innovazione, offrendo un'esperienza culinaria unica nel cuore della citt√†.</p></div></section>`,
                        
                        'gallery-food': `<section class="section"><div class="container"><h2>üì∏ Gallery Piatti</h2><div class="grid"><div class="card" style="background: linear-gradient(45deg, #ff6b6b, #feca57); color: white; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center;"><h3>ü•ó Piatto del Giorno</h3></div><div class="card" style="background: linear-gradient(45deg, #48cae4, #023e8a); color: white; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center;"><h3>üçù Pasta Fresca</h3></div><div class="card" style="background: linear-gradient(45deg, #f72585, #b5179e); color: white; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center;"><h3>ü•© Carne alla Griglia</h3></div></div></div></section>`,
                        
                        'reviews-customers': `<section class="section"><div class="container"><h2>‚≠ê Recensioni Clienti</h2><div class="grid"><div class="card"><h3>Marco R.</h3><p>"Esperienza fantastica! Il cibo √® delizioso e il servizio impeccabile. Consiglio vivamente!"</p><div style="color: #ffd700;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div></div><div class="card"><h3>Sofia M.</h3><p>"Ambiente accogliente e piatti creativi. Perfetto per una serata romantica."</p><div style="color: #ffd700;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div></div><div class="card"><h3>Andrea T.</h3><p>"Qualit√† eccellente e prezzi giusti. Torner√≤ sicuramente!"</p><div style="color: #ffd700;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div></div></div></div></section>`,
                        
                        'contact-reservation': `<section class="section" id="contact"><div class="container"><h2>üìû Contatti & Prenotazioni</h2><div class="grid"><div class="card"><h3>üìç Dove Siamo</h3><p>Via Roma 123<br>00100 Roma, Italia</p></div><div class="card"><h3>üìû Telefono</h3><p>+39 06 123 4567<br>Aperto: 19:00 - 23:30</p></div><div class="card"><h3>üìß Email</h3><p>info@${generatedLayout.businessName.toLowerCase().replace(/\s+/g, '')}.com</p></div></div></div></section>`,
                        
                        'footer-social': `<footer class="footer"><div class="container"><p>ü§ñ Generated by AI-Trainer | Score: ${generatedLayout.semanticScore}/100</p><div style="margin-top: 1rem;"><span style="margin: 0 1rem;">üìò Facebook</span><span style="margin: 0 1rem;">üì∑ Instagram</span><span style="margin: 0 1rem;">üê¶ Twitter</span></div></div></footer>`
                    };
                    
                    return blockMap[blockName] || `<section class="section"><div class="container"><h2>${blockName}</h2><p>Sezione generata dall'AI: ${blockName}</p></div></section>`;
                };
                
                // Generate HTML from AI blocks
                const sectionsHTML = generatedLayout.layout.map(block => generateSectionHTML(block)).join('\n');
                
                console.log('üîç Generated sections HTML:', sectionsHTML.substring(0, 500) + '...');
                logMessage(`üîß Generated ${generatedLayout.layout.length} dynamic sections`, 'info');
                
                // Create a preview HTML
                const previewHTML = `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generated Layout - ${generatedLayout.businessName || 'Preview'}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
        .hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4rem 0; text-align: center; }
        .hero h1 { font-size: 3rem; margin-bottom: 1rem; }
        .hero p { font-size: 1.2rem; opacity: 0.9; }
        .section { padding: 3rem 0; }
        .section:nth-child(even) { background: #f8f9fa; }
        .section h2 { font-size: 2rem; margin-bottom: 2rem; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem; }
        .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .footer { background: #1a202c; color: white; padding: 2rem 0; text-align: center; }
        .ai-badge { position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem; z-index: 1001; }
        a { color: inherit; text-decoration: none; }
        a:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <div class="ai-badge">ü§ñ AI Generated (${generatedLayout.style})</div>
    ${sectionsHTML}
</body>
</html>`;
                
                // Open in new window with blob URL
                const blob = new Blob([previewHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const previewWindow = window.open(url, '_blank');
                
                // Clean up blob URL after a delay
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                logMessage('‚úÖ Layout preview opened in new window', 'success');
                
            } catch (error) {
                logMessage(`‚ùå Preview Error: ${error.message}`, 'error');
            }
        }
        
        // üöÄ BATCH AUTO-TRAINING FUNCTIONS
        
        // Test sites for batch training - 50 diverse sites for comprehensive AI training
        const testSites = [
            // üçï RESTAURANTS (10 sites)
            { url: 'https://www.pizzahut.com', expectedType: 'restaurant', description: 'Pizza restaurant chain' },
            { url: 'https://www.mcdonalds.com', expectedType: 'restaurant', description: 'Fast food restaurant' },
            { url: 'https://www.starbucks.com', expectedType: 'restaurant', description: 'Coffee shop chain' },
            { url: 'https://www.kfc.com', expectedType: 'restaurant', description: 'Fried chicken restaurant' },
            { url: 'https://www.subway.com', expectedType: 'restaurant', description: 'Sandwich restaurant' },
            { url: 'https://www.burgerking.com', expectedType: 'restaurant', description: 'Burger restaurant' },
            { url: 'https://www.dominos.com', expectedType: 'restaurant', description: 'Pizza delivery' },
            { url: 'https://www.tacobellglobal.com', expectedType: 'restaurant', description: 'Mexican fast food' },
            { url: 'https://www.dunkindonuts.com', expectedType: 'restaurant', description: 'Donuts and coffee' },
            { url: 'https://www.chipotle.com', expectedType: 'restaurant', description: 'Mexican grill' },

            // üõí ECOMMERCE (15 sites)
            { url: 'https://www.etsy.com', expectedType: 'ecommerce', description: 'Handmade marketplace' },
            { url: 'https://www.amazon.com', expectedType: 'ecommerce', description: 'Online marketplace' },
            { url: 'https://www.ebay.com', expectedType: 'ecommerce', description: 'Auction marketplace' },
            { url: 'https://www.walmart.com', expectedType: 'ecommerce', description: 'Retail store' },
            { url: 'https://www.target.com', expectedType: 'ecommerce', description: 'Department store' },
            { url: 'https://www.bestbuy.com', expectedType: 'ecommerce', description: 'Electronics retailer' },
            { url: 'https://www.homedepot.com', expectedType: 'ecommerce', description: 'Home improvement' },
            { url: 'https://www.lowes.com', expectedType: 'ecommerce', description: 'Hardware store' },
            { url: 'https://www.costco.com', expectedType: 'ecommerce', description: 'Wholesale retailer' },
            { url: 'https://www.macys.com', expectedType: 'ecommerce', description: 'Department store' },
            { url: 'https://www.nike.com', expectedType: 'ecommerce', description: 'Sportswear brand' },
            { url: 'https://www.adidas.com', expectedType: 'ecommerce', description: 'Athletic apparel' },
            { url: 'https://www.zara.com', expectedType: 'ecommerce', description: 'Fashion retailer' },
            { url: 'https://www.hm.com', expectedType: 'ecommerce', description: 'Fashion chain' },
            { url: 'https://www.ikea.com', expectedType: 'ecommerce', description: 'Furniture retailer' },

            // üè† REAL ESTATE (10 sites)
            { url: 'https://www.remax.com', expectedType: 'real_estate', description: 'Real estate agency' },
            { url: 'https://www.zillow.com', expectedType: 'real_estate', description: 'Real estate platform' },
            { url: 'https://www.realtor.com', expectedType: 'real_estate', description: 'Property listings' },
            { url: 'https://www.coldwellbanker.com', expectedType: 'real_estate', description: 'Real estate brokerage' },
            { url: 'https://www.century21.com', expectedType: 'real_estate', description: 'Real estate franchise' },
            { url: 'https://www.kw.com', expectedType: 'real_estate', description: 'Keller Williams Realty' },
            { url: 'https://www.sothebysrealty.com', expectedType: 'real_estate', description: 'Luxury real estate' },
            { url: 'https://www.cbcommercial.com', expectedType: 'real_estate', description: 'Commercial real estate' },
            { url: 'https://www.cushmanwakefield.com', expectedType: 'real_estate', description: 'Commercial real estate services' },
            { url: 'https://www.cbre.com', expectedType: 'real_estate', description: 'Commercial real estate' },

            // ‚úàÔ∏è TRAVEL (10 sites)
            { url: 'https://www.booking.com', expectedType: 'travel', description: 'Hotel booking platform' },
            { url: 'https://www.expedia.com', expectedType: 'travel', description: 'Travel booking site' },
            { url: 'https://www.airbnb.com', expectedType: 'travel', description: 'Vacation rentals' },
            { url: 'https://www.hotels.com', expectedType: 'travel', description: 'Hotel reservations' },
            { url: 'https://www.priceline.com', expectedType: 'travel', description: 'Travel deals' },
            { url: 'https://www.kayak.com', expectedType: 'travel', description: 'Travel search engine' },
            { url: 'https://www.tripadvisor.com', expectedType: 'travel', description: 'Travel reviews' },
            { url: 'https://www.marriott.com', expectedType: 'travel', description: 'Hotel chain' },
            { url: 'https://www.hilton.com', expectedType: 'travel', description: 'Hotel group' },
            { url: 'https://www.delta.com', expectedType: 'travel', description: 'Airline company' },

            // üîß SERVICES (5 sites)
            { url: 'https://www.squarespace.com', expectedType: 'services', description: 'Website building service' },
            { url: 'https://www.wix.com', expectedType: 'services', description: 'Website builder' },
            { url: 'https://www.wordpress.com', expectedType: 'services', description: 'Blog platform' },
            { url: 'https://www.shopify.com', expectedType: 'services', description: 'Ecommerce platform' },
            { url: 'https://www.godaddy.com', expectedType: 'services', description: 'Domain and hosting' }
        ];
        
        async function testAutoClassification() {
            try {
                // Use selected training sites if available, otherwise use default test sites
                const sitesToTest = selectedTrainingSites.length > 0 ? 
                    selectedTrainingSites.map(site => ({
                        url: typeof site === 'string' ? site : site.url,
                        expectedType: 'unknown'
                    })) : 
                    [
                        { url: 'https://www.starbucks.com', expectedType: 'restaurant' },
                        { url: 'https://www.apple.com', expectedType: 'technology' },
                        { url: 'https://www.amazon.com', expectedType: 'ecommerce' },
                        { url: 'https://www.airbnb.com', expectedType: 'travel' },
                        { url: 'https://www.stripe.com', expectedType: 'tech-startup' }
                    ];

                logMessage(`üß† Testing auto-classification on ${sitesToTest.length} sites...`, 'info');
                
                for (let i = 0; i < sitesToTest.length; i++) {
                    const site = sitesToTest[i];
                    logMessage(`üîç Analyzing ${site.url} (expected: ${site.expectedType})...`, 'info');
                    
                    try {
                        // Simulate classification API call
                        const response = await fetch(`${API_BASE}/api/training/classify`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${API_KEY}`
                            },
                            body: JSON.stringify({
                                url: site.url,
                                expectedType: site.expectedType
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            const accuracy = result.detectedType === site.expectedType ? '‚úÖ CORRECT' : '‚ùå WRONG';
                            logMessage(`  üìä Detected: ${result.detectedType} ${accuracy} (confidence: ${result.confidence}%)`, 
                                      result.detectedType === site.expectedType ? 'success' : 'error');
                        } else {
                            logMessage(`  ‚ùå Classification failed: ${result.error}`, 'error');
                        }
                        
                    } catch (error) {
                        logMessage(`  ‚ùå Error analyzing ${site.url}: ${error.message}`, 'error');
                    }
                    
                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                logMessage('üéØ Auto-classification test completed!', 'success');
                
            } catch (error) {
                logMessage(`‚ùå Auto-classification test failed: ${error.message}`, 'error');
            }
        }
        
        async function startBatchTraining() {
            try {
                // Check if sites are selected
                if (!selectedTrainingSites || selectedTrainingSites.length === 0) {
                    alert('‚ö†Ô∏è Please select or generate training sites first!');
                    return;
                }
                
                const progressDiv = document.getElementById('batch-progress');
                const statusDiv = document.getElementById('batch-status');
                const progressBar = document.getElementById('batch-progress-bar');
                
                // Show progress UI
                progressDiv.style.display = 'block';
                statusDiv.textContent = 'üöÄ Starting Complete Auto Training...';
                progressBar.style.width = '0%';
                
                logMessage('ü§ñ Starting Complete Automatic Training Process...', 'info');
                logMessage(`üìã Training Sites: ${selectedTrainingSites.join(', ')}`, 'info');
                logMessage('üìã Steps: 1) Collect HTML ‚Üí 2) Extract CSS ‚Üí 3) Analyze Colors ‚Üí 4) Analyze Fonts ‚Üí 5) Classify Patterns ‚Üí 6) Export Data', 'info');
                
                // Step 1: Collect HTML from all sites (0-20%)
                statusDiv.textContent = 'üìä Step 1/6: Collecting HTML from sites...';
                progressBar.style.width = '5%';
                
                const htmlResponse = await fetch(`${API_BASE}/api/training/auto-html`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        sites: selectedTrainingSites,
                        batchSize: 10
                    })
                });
                
                const htmlData = await htmlResponse.json();
                if (!htmlData.success) throw new Error(`HTML Collection failed: ${htmlData.error}`);
                
                progressBar.style.width = '20%';
                logMessage(`‚úÖ Step 1 Complete: ${htmlData.sitesProcessed} sites HTML collected`, 'success');
                
                // Step 2: Extract CSS patterns (20-40%)
                statusDiv.textContent = 'üé® Step 2/6: Extracting CSS patterns...';
                
                const cssResponse = await fetch(`${API_BASE}/api/training/auto-css`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        sessionId: htmlData.sessionId
                    })
                });
                
                const cssData = await cssResponse.json();
                if (!cssData.success) throw new Error(`CSS Extraction failed: ${cssData.error}`);
                
                progressBar.style.width = '40%';
                logMessage(`‚úÖ Step 2 Complete: ${cssData.patternsExtracted} CSS patterns extracted`, 'success');
                
                // Step 3: Analyze Colors (40-60%)
                statusDiv.textContent = 'üåà Step 3/6: Analyzing color schemes...';
                
                const colorResponse = await fetch(`${API_BASE}/api/training/auto-colors`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        sessionId: htmlData.sessionId
                    })
                });
                
                const colorData = await colorResponse.json();
                if (!colorData.success) throw new Error(`Color Analysis failed: ${colorData.error}`);
                
                progressBar.style.width = '60%';
                logMessage(`‚úÖ Step 3 Complete: ${colorData.colorSchemesAnalyzed} color schemes analyzed`, 'success');
                
                // Step 4: Analyze Fonts (60-80%)
                statusDiv.textContent = 'üî§ Step 4/6: Analyzing typography...';
                
                const fontResponse = await fetch(`${API_BASE}/api/training/auto-fonts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        sessionId: htmlData.sessionId
                    })
                });
                
                const fontData = await fontResponse.json();
                if (!fontData.success) throw new Error(`Font Analysis failed: ${fontData.error}`);
                
                progressBar.style.width = '80%';
                logMessage(`‚úÖ Step 4 Complete: ${fontData.fontsAnalyzed} font combinations analyzed`, 'success');
                
                // Step 5: Classify Design Patterns (80-95%)
                statusDiv.textContent = 'üß† Step 5/6: Classifying design patterns...';
                
                const classifyResponse = await fetch(`${API_BASE}/api/training/auto-classify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        sessionId: htmlData.sessionId
                    })
                });
                
                const classifyData = await classifyResponse.json();
                if (!classifyData.success) throw new Error(`Pattern Classification failed: ${classifyData.error}`);
                
                progressBar.style.width = '95%';
                logMessage(`‚úÖ Step 5 Complete: ${classifyData.patternsClassified} design patterns classified`, 'success');
                
                // Step 6: Export & Train AI (95-100%)
                statusDiv.textContent = 'üíæ Step 6/6: Finalizing AI training...';
                
                const exportResponse = await fetch(`${API_BASE}/api/training/auto-finalize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        sessionId: htmlData.sessionId
                    })
                });
                
                const exportData = await exportResponse.json();
                if (!exportData.success) throw new Error(`Training Finalization failed: ${exportData.error}`);
                
                // Success!
                progressBar.style.width = '100%';
                progressBar.style.background = '#28a745';
                statusDiv.textContent = `üéâ Complete Auto Training Finished!`;
                
                logMessage(`‚úÖ Step 6 Complete: AI model updated with new patterns`, 'success');
                logMessage(`üéØ TRAINING SUMMARY:`, 'info');
                logMessage(`üìä Sites Processed: ${exportData.totalSites}`, 'info');
                logMessage(`üé® CSS Patterns: ${exportData.cssPatterns}`, 'info');
                logMessage(`üåà Color Schemes: ${exportData.colorSchemes}`, 'info');
                logMessage(`üî§ Font Combinations: ${exportData.fontCombinations}`, 'info');
                logMessage(`üß† Design Patterns: ${exportData.designPatterns}`, 'info');
                logMessage(`üöÄ AI Model Accuracy: ${exportData.accuracy}%`, 'success');
                
                // Update UI counters
                document.getElementById('totalSamples').textContent = exportData.totalSamples || 0;
                document.getElementById('customSitesCount').textContent = exportData.totalSites || 0;
                
            } catch (error) {
                logMessage(`‚ùå Complete Auto Training Error: ${error.message}`, 'error');
                document.getElementById('batch-status').textContent = `‚ùå Auto Training Failed: ${error.message}`;
                document.getElementById('batch-progress-bar').style.background = '#dc3545';
            }
        }
        
        // üé® GRAPHIC IMPROVEMENT FUNCTIONS
        async function saveDesignData(site, designData) {
            try {
                logMessage(`üíæ Saving design data for ${site.url}...`, 'info');
                
                const response = await fetch(`${API_BASE}/api/design/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        url: site.url,
                        businessType: site.expectedType,
                        description: site.description,
                        designData: designData,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    logMessage(`  ‚úÖ Design data saved: ${result.savedId}`, 'success');
                } else {
                    logMessage(`  ‚ö†Ô∏è Failed to save design data: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`  ‚ùå Error saving design data: ${error.message}`, 'error');
            }
        }
        
        async function generateImprovedCSS() {
            try {
                logMessage('üé® Generating improved CSS library from collected design data...', 'info');
                
                const response = await fetch(`${API_BASE}/api/design/generate-css`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        includeBusinessTypes: ['restaurant', 'ecommerce', 'real_estate', 'travel', 'services'],
                        generateThemes: true,
                        generateColorPalettes: true,
                        generateTypography: true,
                        generateLayouts: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    logMessage(`‚úÖ CSS library generated: ${result.cssFiles?.length || 0} files`, 'success');
                    logMessage(`üé® Color palettes: ${result.colorPalettes?.length || 0} themes`, 'success');
                    logMessage(`üìù Typography sets: ${result.typography?.length || 0} font combinations`, 'success');
                    logMessage(`üìê Layout patterns: ${result.layouts?.length || 0} responsive patterns`, 'success');
                    
                    // Show preview of generated styles
                    if (result.previewURL) {
                        logMessage(`üëÄ Preview available at: ${result.previewURL}`, 'info');
                    }
                    
                } else {
                    logMessage(`‚ùå Failed to generate CSS library: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Error generating CSS library: ${error.message}`, 'error');
            }
        }
        
        // üé® DESIGN INTELLIGENCE ENGINE - AUTOMATIC EXTRACTION
        async function extractDesignLibrary() {
            try {
                logMessage('üé® Starting design library extraction from analyzed sites...', 'info');
                
                const response = await fetch(`${API_BASE}/api/design/extract-library`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        extractionMode: 'automatic',
                        includePatterns: true,
                        businessTypes: ['restaurant', 'ecommerce', 'tech-startup', 'portfolio']
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    logMessage(`üé® Design extraction completed!`, 'success');
                    logMessage(`üìä Extracted: ${result.extracted.cssThemes} CSS themes, ${result.extracted.colorPalettes} palettes`, 'success');
                    logMessage(`üìù Font combinations: ${result.extracted.fontCombinations}`, 'info');
                    logMessage(`üìê Layout patterns: ${result.extracted.layoutPatterns}`, 'info');
                    
                    // Update extraction stats
                    updateExtractionStats(result.extracted);
                    
                } else {
                    logMessage(`‚ùå Design extraction failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Extraction error: ${error.message}`, 'error');
            }
        }
        
        async function analyzeStoredPatterns() {
            try {
                logMessage('üìä Analyzing stored design patterns...', 'info');
                
                const response = await fetch(`${API_BASE}/api/design/analyze-patterns`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    logMessage(`üìä Pattern analysis completed!`, 'success');
                    logMessage(`üèÜ Best performing patterns: ${result.analysis.topPatterns}`, 'info');
                    logMessage(`üìà Quality score average: ${result.analysis.avgQualityScore}%`, 'info');
                    logMessage(`üéØ Business type coverage: ${result.analysis.businessTypeCoverage.join(', ')}`, 'info');
                    
                } else {
                    logMessage(`‚ùå Pattern analysis failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Analysis error: ${error.message}`, 'error');
            }
        }
        
        async function classifyTrainingSamples() {
            try {
                logMessage('üß† Auto-classifying training samples by design patterns...', 'info');
                
                const response = await fetch(`${API_BASE}/api/design/classify-samples`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        classificationCriteria: ['businessType', 'colorScheme', 'layoutStructure', 'typography'],
                        autoTag: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    logMessage(`üß† Classification completed!`, 'success');
                    logMessage(`üìä Classified ${result.classified.totalSamples} samples`, 'success');
                    logMessage(`üè∑Ô∏è Auto-tagged: ${result.classified.autoTagged} patterns`, 'info');
                    logMessage(`üìà Confidence average: ${result.classified.avgConfidence}%`, 'info');
                    
                } else {
                    logMessage(`‚ùå Classification failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Classification error: ${error.message}`, 'error');
            }
        }
        
        async function exportCSSLibrary() {
            try {
                logMessage('üíæ Exporting CSS library from extracted patterns...', 'info');
                
                const response = await fetch(`${API_BASE}/api/design/export-library`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        format: 'css',
                        includeResponsive: true,
                        businessTypes: 'all',
                        qualityThreshold: 7.0
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Create downloadable CSS file
                    const cssBlob = new Blob([result.cssContent], { type: 'text/css' });
                    const url = URL.createObjectURL(cssBlob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ai-trainer-library-${new Date().toISOString().split('T')[0]}.css`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    logMessage(`üíæ CSS library exported!`, 'success');
                    logMessage(`üìä Exported ${result.exportStats.themes} themes in ${result.exportStats.fileSize}`, 'success');
                    
                } else {
                    logMessage(`‚ùå Export failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Export error: ${error.message}`, 'error');
            }
        }
        
        function updateExtractionStats(extracted) {
            document.getElementById('extractedCSS').textContent = extracted.cssThemes || 0;
            document.getElementById('extractedColors').textContent = extracted.colorPalettes || 0;
            document.getElementById('extractedFonts').textContent = extracted.fontCombinations || 0;
            document.getElementById('extractedPatterns').textContent = extracted.layoutPatterns || 0;
        }
        
        async function loadExtractionStats() {
            try {
                const response = await fetch(`${API_BASE}/api/design/extraction-stats`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateExtractionStats(result.stats);
                    logMessage(`üìä Extraction stats loaded`, 'info');
                }
                
            } catch (error) {
                logMessage(`‚ùå Failed to load extraction stats: ${error.message}`, 'error');
            }
        }

        // üé® GRAPHIC STATS MONITORING
        async function loadGraphicStats() {
            try {
                logMessage('üìä Loading graphic library stats...', 'info');
                
                const response = await fetch(`${API_BASE}/api/design/stats`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update main stats
                    document.getElementById('colorPalettes').textContent = result.stats.colorPalettes || 0;
                    document.getElementById('fontCombos').textContent = result.stats.fontCombos || 0;
                    
                    // Update detailed stats in graphic card
                    const colorPalettesDetail = document.querySelector('#graphic-stats #colorPalettes');
                    const fontCombosDetail = document.querySelector('#graphic-stats #fontCombos');
                    const cssRulesDetail = document.querySelector('#graphic-stats #cssRules');
                    
                    if (colorPalettesDetail) colorPalettesDetail.textContent = result.stats.colorPalettes || 0;
                    if (fontCombosDetail) fontCombosDetail.textContent = result.stats.fontCombos || 0;
                    if (cssRulesDetail) cssRulesDetail.textContent = result.stats.cssRules || 0;
                    
                    logMessage(`üìä Graphic Stats Loaded: ${result.stats.colorPalettes} palettes, ${result.stats.fontCombos} combos`, 'success');
                    
                } else {
                    logMessage(`‚ö†Ô∏è Failed to load graphic stats: ${result.error}`, 'error');
                }
                
            } catch (error) {
                logMessage(`‚ùå Graphic stats error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
